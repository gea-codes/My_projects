Задание 4.1

База данных содержит список аэропортов практически всех крупных городов России. 
В большинстве городов есть только один аэропорт. Исключение составляет: Moscow, Ulyanovsk.

SELECT
    city
FROM
    dst_project.airports
GROUP BY
    city
HAVING
    count(airport_code)>1

Задание 4.2

Вопрос 1. Таблица рейсов содержит всю информацию о прошлых, текущих и запланированных рейсах.
Сколько всего статусов для рейсов определено в таблице? - 6.

SELECT
    count(distinct status)
FROM
    dst_project.flights

Вопрос 2. Какое количество самолетов находятся в воздухе на момент среза в базе
(статус рейса «самолёт уже вылетел и находится в воздухе»). - 58.

SELECT
    count(f.flight_id)
FROM
    dst_project.flights f
WHERE 
    f.status = 'Departed'

Вопрос 3. Места определяют схему салона каждой модели. Сколько мест имеет самолет модели  (Boeing 777-300)? - 402.

SELECT
    count(s.seat_no)
FROM
    dst_project.seats s
WHERE 
    s.aircraft_code = '773'



Вопрос 4. Сколько состоявшихся (фактических) рейсов было совершено между 1 апреля 2017 года и 1 сентября 2017 года? - 74,227.

SELECT
    count(flight_id)
FROM
    dst_project.flights 
WHERE
    status = 'Arrived'
    and (date_part('year', actual_arrival) = 2017)
    and (date_part('month', actual_arrival) in (4, 5, 6, 7, 8, 9))


Задание 4.3

Вопрос 1. Сколько всего рейсов было отменено по данным базы? - 41.

SELECT
    count(f.flight_id)
FROM
    dst_project.flights f
WHERE 
    f.status = 'Cancelled'


Вопрос 2. Сколько самолетов моделей типа Boeing, Sukhoi Superjet, Airbus находится в базе авиаперевозок? - 3, 1, 3.

SELECT 'Boeing',
       count(*)
FROM dst_project.aircrafts a
WHERE a.model LIKE 'Boeing%'
UNION ALL
SELECT 'Sukhoi Superjet',
       count(*)
FROM dst_project.aircrafts a
WHERE a.model LIKE 'Sukhoi Superjet%'
UNUON ALL
SELECT 'Airbus',
       count(*)
FROM dst_project.aircrafts a
WHERE a.model LIKE 'Airbus%'

Вопрос 3. В какой части (частях) света находится больше аэропортов? - Europe, Asia.

SELECT 
    distinct a.timezone,
    count(a.airport_code) number
FROM 
    dst_project.airports a
WHERE
    a.timezone LIKE 'Europe%'
GROUP BY 
    a.timezone


Вопрос 3. В какой части (частях) света находится больше аэропортов? - Europe, Asia.

SELECT 'Europe',
       count(*)
FROM dst_project.airports a
WHERE a.timezone LIKE 'Europe%'
union all
SELECT 'Asia',
       count(*)
FROM dst_project.airports a
WHERE a.timezone LIKE 'Asia%'


Вопрос 4. У какого рейса была самая большая задержка прибытия за все время сбора данных? Введите id рейса (flight_id). - 24165

SELECT
    f.flight_id,
    f.scheduled_arrival - f.actual_arrival diff
FROM
    dst_project.flights f
where f.status = 'Arrived'
GROUP BY
    diff, f.flight_id

Задание 4.4

Вопрос 1. Когда был запланирован самый первый вылет, сохраненный в базе данных? - 14.08.2016

SELECT
    f.scheduled_departure
FROM
    dst_project.flights f
ORDER BY
    f.scheduled_departure 

Вопрос 2. Сколько минут составляет запланированное время полета в самом длительном рейсе? - 530.

SELECT
    DATE_PART('hour', f.scheduled_arrival  - scheduled_departure) * 60 +
    DATE_PART('minute', f.scheduled_arrival - scheduled_departure) flight
FROM
    dst_project.flights f
order by flight desc 
limit 1


Вопрос 3. Между какими аэропортами пролегает самый длительный по времени запланированный рейс? -
DME - UUS.

SELECT
   f.departure_airport,
   f.arrival_airport,
   f.scheduled_arrival - f.scheduled_departure as flight
FROM
    dst_project.flights f
GROUP BY
    flight, f.departure_airport, f.arrival_airport
ORDER BY
    flight desc
LIMIT 5

Вопрос 4. Сколько составляет среднее время полета среди всех самолетов в минутах? - 128.

SELECT
    avg(DATE_PART('hour', f.scheduled_arrival  - scheduled_departure) * 60 +
    DATE_PART('minute', f.scheduled_arrival - scheduled_departure))
FROM
    dst_project.flights f

Задание 4.5

Вопрос 1. Мест какого класса у SU9 больше всего? - Economy.

SELECT
    'Economy',
    count(*)
FROM
    dst_project.seats s
WHERE 
    s.aircraft_code = 'SU9'
    and s.fare_conditions = 'Economy'
UNION ALL
SELECT
    'Business',
    count(*)
FROM
    dst_project.seats s
WHERE 
    s.aircraft_code = 'SU9'
    and s.fare_conditions = 'Business'
UNION ALL
SELECT
    'Comfort',
    count(*)
FROM
    dst_project.seats s
WHERE 
    s.aircraft_code = 'SU9'
    and s.fare_conditions = 'Comfort'
UNION ALL
SELECT
    'Standart',
    count(*)
FROM
    dst_project.seats s
WHERE 
    s.aircraft_code = 'SU9'
    and s.fare_conditions = 'Standart'

Вопрос 2. Какую самую минимальную стоимость составило бронирование за всю историю? - 3400

SELECT
   min(b.total_amount)
FROM
    dst_project.bookings b 

Вопрос 3. Какой номер места был у пассажира с id = 4313 788533? - 2A. 

SELECT
   t.passenger_id,
   s.seat_no
FROM
    dst_project.seats s
        join 
            dst_project.boarding_passes bp on s.seat_no = bp.seat_no
                join
                    dst_project.tickets t on bp.ticket_no = t.ticket_no
WHERE t.passenger_id = '4313 788533'
GROUP BY 
    s.seat_no, t.passenger_id


Задание 5.1

Вопрос 1. Анапа — курортный город на юге России. Сколько рейсов прибыло в Анапу за 2017 год? - 486.

SELECT
   a.city,
   count(f.flight_id)
FROM
    dst_project.flights f
        join 
            dst_project.airports a on f.arrival_airport = a.airport_code
WHERE a.city = 'Anapa'
    and f.status = 'Arrived'
    and date_part('year', actual_arrival) = 2017)
GROUP BY 
    a.city

Вопрос 2. Сколько рейсов из Анапы вылетело зимой 2017 года? - 127.

SELECT
   a.city,
   count(f.flight_id)
FROM
    dst_project.flights f
        join 
            dst_project.airports a on f.arrival_airport = a.airport_code
WHERE a.city = 'Anapa' 
    and (date_part('year', actual_arrival) = 2017)
    and (date_part('month', actual_arrival) in (12, 1, 2))
GROUP BY 
    a.city


Вопрос 3. Посчитайте количество отмененных рейсов из Анапы за все время. - 1

SELECT
   a.city,
   count(f.flight_id)
FROM
    dst_project.flights f
        join 
            dst_project.airports a on f.arrival_airport = a.airport_code
WHERE f.departure_airport = 'AAQ' 
    and f.status = 'Cancelled'
GROUP BY 
    a.city


Вопрос 4. Сколько рейсов из Анапы не летают в Москву? - 453

SELECT
    count(distinct f.flight_id)
FROM dst_project.flights f
	JOIN dst_project.airports a ON a.airport_code = f.departure_airport
	JOIN dst_project.airports aa ON aa.airport_code = f.arrival_airport
WHERE a.city = 'Anapa'
	AND aa.city != 'Moscow'

Вопрос 5. Какая модель самолета летящего на рейсах из Анапы имеет больше всего мест? - Boeing 737-300.

SELECT
    a.model,
    count(distinct s.seat_no)
FROM dst_project.aircrafts a
	JOIN dst_project.seats s ON a.aircraft_code = s.aircraft_code
	JOIN dst_project.flights f ON a.aircraft_code = f.aircraft_code
WHERE f.departure_airport = 'AAQ'
GROUP BY a.model


__________________________________________________________________

Запрос в Metabase для csv таблицы: 

SELECT *
FROM dst_project.flights
WHERE departure_airport = 'AAQ'
  AND (date_trunc('month', scheduled_departure) in ('2017-01-01','2017-02-01', '2016-12-01'))
  AND status not in ('Cancelled')

И затем добавляем данные с помощью: 

SELECT
    tf.flight_id,
    COUNT(tf.ticket_no) sold_tickets,
    SUM(tf.amount) total_amount_tickets
    --MAX(b.boarding_no) fill
FROM dst_project.flights f
    join dst_project.ticket_flights tf on f.flight_id = tf.flight_id
        join dst_project.boarding_passes b ON tf.flight_id=b.flight_id
WHERE departure_airport = 'AAQ'
  AND (date_trunc('month', scheduled_departure) in ('2017-01-01','2017-02-01', '2016-12-01'))
  AND status not in ('Cancelled')
GROUP BY tf.flight_id








